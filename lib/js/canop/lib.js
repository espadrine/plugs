(function(e,t){typeof define=="function"&&define.amd?define([],t):typeof exports=="object"?module.exports=t():e.canop=t()})(this,function(){function v(e,t,n,r,i){this.mark=[+r,+i,d++],this.action=e,this.key=t,this.value=n,this.original=null}function m(e,t,n,r,i){this.lowKey=e,this.highKey=t,this.change=n,this.originalLowKey=r||e,this.originalHighKey=i||t,this.inverted=!1}function y(e){this.list=e||[]}function b(e,t){for(var n=0;n<Math.min(e.length,t.length);n++){if(e[n]<t[n])return-1;if(e[n]>t[n])return 1}return e.length<t.length?-1:e.length>t.length?1:0}function w(e,t){if(!e||!t)return!1;var n=e.length;if(n!==t.length)return!1;for(var r=0,n=e;r<n;r++)if(e[r]!==t[r])return!1;return!0}function T(e){var i=this;e=e||{},this.base=e.base||0,this.id=0,this.local=new y,this.sent=new y,this.canon=new y,this.listeners={},this.on("change",function(e){i.updateData(e)}),this.on("localChange",function(e){i.updateData(e)}),this.disableData=!!e.disableData,this.data=undefined,e.data!==undefined?(this.isServer=!0,this.base=e.base||1,this.data=e.data,this.emit("localChange",{changes:[[[],t.set,this.data]]})):this.isServer=!1,this.send=e.send||function(){throw"Default Canop send operation"},this.clients={},this.nextClientId=1,this.clientCount=0,this.signalFromClient=Object.create(null),this.clientState=E;if(!this.isServer){var s=function(){try{i.id===0?i.send(JSON.stringify([r,n])):i.send(JSON.stringify([f,i.id,i.base])),i.clientState=S,i.clientCount++}catch(e){i.emit("unsyncable",e)}};this.on("unsyncable",function(){if(i.clientState===E)return;i.clientState=E,i.once("syncing",s)}),this.once("syncing",s),this.on("signal",function(e){e.data.connected!==undefined&&(e.data.connected?i.clientCount++:i.clientCount--)})}}var e={},t={pass:0,set:1,stringAdd:8,stringRemove:9},n=0,r=0,i=1,s=2,o=3,u=4,a=5,f=6,l=7,c=0,h=["UnknownBaseError"],p=9007199254740991,d=0;e.AtomicOperation=v,v.prototype={dup:function(){return v.fromObject(this)},change:function(){if(this.action===t.stringAdd)return new m(this.key,this.key+this.value.length,this.value.length,this.original?this.original.key:null);if(this.action===t.stringRemove)return new m(this.key,this.key+this.value.length,-this.value.length,this.original?this.original.key:null)},rebaseable:function(){return this.action===t.stringAdd||this.action===t.stringRemove},getModifiedBy:function(n){if(!this.rebaseable())return;var r=this.key+this.value.length;this.original={mark:this.mark.slice(),action:this.action,key:this.key,value:this.value};var i=g(this.key,n);if(this.action===t.stringAdd)var s=i+this.value.length;else if(this.action===t.stringRemove)var s=g(r,n);if(i===undefined||s===undefined)this.action=t.pass;else{this.key=i;var o=this.key+this.value.length;if(s<o)this.value=this.value.slice(0,s-i);else if(s>o)for(var u=0;u<s-o;u++)this.value+=" "}},inverse:function(){var n=this.dup();if(this.action===t.stringAdd)n.action=t.stringRemove;else if(this.action===t.stringRemove)n.action=t.stringAdd;else if(this.action===t.set){var r=n.key;n.key=n.value,n.value=r}return n},toProtocol:function(){return[this.mark,[this.action,this.key,this.value]]}},m.prototype={dup:function(){return new m(this.lowKey,this.highKey,this.change,this.originalLowKey,this.originalHighKey)},update:function(t,n){if(this.highKey<=t)return t+this.change;if(this.lowKey<=t){if(this.change>=0)return this.lowKey<t?t+this.change:this.originalLowKey<n?t+this.change:t;if(this.lowKey<t)return;return t}return t},inverse:function(){var t=this.dup();return t.change=-t.change,t.inverted=!t.inverted,t},mirror:function(t){return this.change===-t.change&&this.originalLowKey===t.originalLowKey&&this.originalHighKey===t.originalHighKey&&this.inverted===!t.inverted}};var g=function(t,n,r){var i=t;for(var s=0;s<n.length;s++){var o=n[s];if(o===undefined){if(r)return t;return}var u=o.update(t,i),a=!1;if(u===undefined){for(var f=s+1;f<n.length;f++)if(o.mirror(n[f])){s=f,a=!0;break}if(!a){if(r)return t;return}}else t=u}return t};v.fromObject=function(e){var t=new v(e.action,e.key,e.value,e.mark[0]);return d--,t.mark=e.mark.slice(),e.original!=null&&(t.original={mark:e.original.mark.slice(),action:e.original.action,key:e.original.key,value:e.original.value}),t},v.fromProtocol=function(e){var t=e[0],n=e[1][0],r=e[1][1],i=e[1][2],s=new v(n,r,i,t[0]);return d--,s.mark=t.slice(),s},e.Operation=y,y.fromProtocol=function(e){var t=new y,n=e[2];for(var r=0;r<n.length;r++)t.list.push(v.fromProtocol(n[r]));return t},y.prototype={apply:function(t){var n=t.dup();this.list=this.list.concat(n.list)},combine:function(t){var n=this.dup(),r=t.dup();return n.list=n.list.concat(r.list),n},dup:function(){var t=new y;t.list=new Array(this.list.length);for(var n=0;n<this.list.length;n++)t.list[n]=this.list[n].dup();return t},inverse:function(){var t=new y;for(var n=this.list.length-1;n>=0;n--){var r=this.list[n].inverse();if(r===undefined)return;t.list.push(r)}return t},change:function N(){var e=[];for(var t=0;t<this.list.length;t++){var N=this.list[t].change();if(N===undefined)return e;e.push(N)}return e},inverseChange:function(){var t=[];for(var n=this.list.length-1;n>=0;n--){var r=this.list[n].change();if(r===undefined)return t;r=r.inverse();if(r===undefined)return t;t.push(r)}return t},add:function(n,r,i,s,o){var u=new v(t.stringAdd,r,i,s,o);return this.list.push(u),u},remove:function(n,r,i,s,o){var u=new v(t.stringRemove,r,i,s,o);return this.list.push(u),u},set:function(n,r,i,s,o){var u=new v(t.set,r,i,s,o);return this.list.push(u),u},toString:function C(){var e="";for(var n=0;n<this.list.length;n++){var r=this.list[n];if(r.action===t.stringAdd){var i=r.key-e.length;for(var s=0;s<i;s++)e+=" ";e=e.slice(0,r.key)+r.value+e.slice(r.key)}else r.action===t.stringRemove?(e.slice(r.key,r.key+r.value.length)!==r.value,e=e.slice(0,r.key)+e.slice(r.key+r.value.length)):r.action===t.set&&(e=r.key)}return e},toProtocol:function(){var e=[];for(var t=0;t<this.list.length;t++){var n=this.list[t];e.push(n.toProtocol())}return[s,[],e]}};var E=0,S=1,x=2;return e.Client=T,e.Server=T,T.prototype={on:function(e,t,n){this.listeners[e]=this.listeners[e]||[],this.listeners[e].push({func:t,options:n})},once:function(e,t,n){var r=this,i=function(){t(),r.removeListener(e,i)};this.on(e,i,n)},emit:function(e,t){var n=this.listeners[e];if(n==null)return;var r=n.slice(),i=r.length;for(var s=0;s<i;s++)r[s].func(t)},removeListener:function(e,t){var n=this.listeners[e];if(n==null)return;var r=n.length;for(var i=0;i<r;i++)if(n[i].func===t){n.splice(i,1);return}},readProtocol:function(e){var n=e;if(typeof n=="string")try{n=JSON.parse(n)}catch(c){throw new Error("Invalid Canop message: "+c.message+"\n"+"Message: "+e)}if(n instanceof Array){if(n[0]!==r)if(n[0]===i){if(n[1]===undefined)throw new Error("Invalid Canop message: undefined state\nMessage:"+e);if(typeof n[2]!="number")throw new Error("Invalid Canop message: non-number base\nMessage: "+e);if(typeof n[3]!="number")throw new Error("Invalid Canop message: non-number machine\nMessage: "+e)}else if(n[0]===s||n[0]===l){if(!(n[1]instanceof Array))throw new Error("Invalid Canop message: delta path is not an Array.\nMessage: "+e);if(!(n[2]instanceof Array))throw new Error("Invalid Canop message: deltas are not an Array.\nMessage: "+e);for(var h=0;h<n[2].length;h++){var p=n[2][h];if(!(p[0]instanceof Array))throw new Error("Invalid Canop message: delta "+h+" has non-Array mark.\nMessage: "+e);for(var d=0;d<p[0].length;d++)if(typeof p[0][d]!="number")throw new Error("Invalid Canop message: delta "+h+" has a non-number in mark at position "+d+".\n"+"Message: "+e);if(!(p[1]instanceof Array))throw new Error("Invalid Canop message: delta "+h+" has non-Array operation.\nMessage: "+e);if(p[1][0]!==t.pass&&p[1][0]!==t.set){if(p[1][0]!==t.stringAdd&&p[1][0]!==t.stringRemove)throw new Error("Invalid Canop message: delta "+h+" has an unsupported operation type.\n"+"Message: "+e);if(typeof p[1][1]!="number")throw new Error("Invalid Canop message: delta "+h+" has non-number string offset.\nMessage: "+e);if(typeof p[1][2]!="string")throw new Error("Invalid Canop message: delta "+h+" has non-string string edition.\nMessage: "+e)}}}else if(n[0]===o){if(typeof n[1]!="number")throw new Error("Invalid Canop message: non-number machine.\nMessage: "+e);if(n[2]!==undefined&&(typeof n[2]!="object"||n[2]instanceof Array))throw new Error("Invalid Canop message: non-object signal.\nMessage: "+e)}else if(n[0]===u||n[0]===a)n[1].forEach(function(t){if(typeof t[0]!="number")throw new Error("Invalid Canop message: non-number error code.\nMessage: "+e);if(typeof t[1]!="string")throw new Error("Invalid Canop message: non-string error message.\nMessage: "+e)});else{if(n[0]!==f)throw new Error("Invalid Canop message: unknown message type "+n[0]+"\nMessage: "+e);if(typeof n[1]!="number")throw new Error("Invalid Canop message: non-number machine.\nMessage: "+e);if(typeof n[2]!="number")throw new Error("Invalid Canop message: non-number base.\nMessage: "+e)}return n}throw new Error("Invalid Canop message: toplevel is not an array.\nMessage: "+e)},receive:function(e){var t=this;try{var n=this.readProtocol(e)}catch(r){console.error(r);return}var f=n[0];if(f===i)this.reset(n[1],n[2],n[3]),this.clientState=x,this.sendToServer();else if(f===l)this.receiveChange(n),this.clientState=x,this.sendToServer();else if(f===s){if(this.clientState!==x)return;this.receiveChange(n),this.sendToServer()}else if(f===o){if(this.clientState!==x)return;var p=n[1],d=n[2];this.signalFromClient[p]=this.signalFromClient[p]||{};if(d!==undefined)for(var v in d)this.signalFromClient[p][v]=d[v];this.emit("signal",{clientId:p,data:d})}else f===u?n[1].forEach(function(e){if(e[0]===c){var e=new Error(e[1]);e.name=h[e[0]],t.emit("unsyncable",e)}}):f===a?n[1].forEach(function(e){console.error(e)}):console.error("Unknown protocol message "+e)},emitChanges:function(e,t,n){var r=t.map(function(e){return[[],e.action,e.key,e.value]});this.emit(e,{changes:r,posChanges:n})},receiveChange:function(e){var t=e[1],n=e[2],r=y.fromProtocol(e),i=this.base;for(var s=0;s<r.list.length;s++)if(i<r.list[s].mark[0])break;var o=s;r.list=r.list.slice(o);var u=this.local.inverse().list.concat(this.sent.inverse().list).concat(r.dup().list),a=this.receiveCanon(r);u=u.concat(this.sent.dup().list).concat(this.local.dup().list),this.emitChanges("change",u,a),this.local.list.length===0&&this.sent.list.length===0&&this.emit("synced")},reset:function(e,n,r){this.local=new y,this.sent=new y,this.canon=new y,this.id=r,this.disableData||(this.data=e),this.receiveChange([s,[],[[[n,r,0],[t.set,e]]]])},localToSent:function(){this.sent.list=this.sent.list.concat(this.local.list),this.local.list=[]},receiveCanon:function(e){if(e.list.length===0)return[];var t=this.sent.dup();for(var n=0;n<e.list.length;n++){var r=e.list[n],i=this.sent.list[0];i!==undefined&&i.mark[1]===r.mark[1]&&i.mark[2]===r.mark[2]&&this.sent.list.shift()}var s=this.local.inverseChange().concat(t.inverseChange()).concat(e.change()),o=this.local.list.length,u=this.sent.list.length;for(var n=0;n<u;n++){var i=this.sent.list[n],a=o+u-n;i.getModifiedBy(s.slice(a)),s.push(i.change())}for(var n=0;n<o;n++){var f=this.local.list[n],a=o-n;f.getModifiedBy(s.slice(a)),s.push(f.change())}this.base=e.list[e.list.length-1].mark[0];for(var n=0;n<this.sent.list.length;n++)this.sent.list[n].mark[0]=this.base;for(var n=0;n<this.local.list.length;n++)this.local.list[n].mark[0]=this.base;return s},sendToServer:function(){if(this.clientState===E||this.clientState===S)return;if(this.sent.list.length>0)return;if(this.local.list.length>0){this.emit("syncing");try{this.send(JSON.stringify(this.local.toProtocol())),this.localToSent()}catch(t){this.emit("unsyncable",t)}}},updateData:function(e){var n=e.changes;for(var r=0;r<n.length;r++){var i=n[r],s=i[0],o=this.data,u=i[1];if(u===t.set)o=i[2];else if(u===t.stringAdd){var a=i[2],f=i[3];o=o.slice(0,a)+f+o.slice(a)}else if(u===t.stringRemove){var a=i[2],f=i[3];o=o.slice(0,a)+o.slice(a+f.length)}this.data=o}},get:function(e){if(this.disableData)throw new Error("Canop was configured not to hold data");if(this.data===undefined)throw new Error("Canop does not hold any data yet");return this.data},add:function(n,r,i){this.act([t.stringAdd,n,r,i]),this.sendToServer()},remove:function(n,r,i){this.act([t.stringRemove,n,r,i]),this.sendToServer()},toString:function(){return this.get([]).toString()},act:function(e){var t=this.commitAction(e);this.emitChanges("localChange",t),this.sendToServer()},actAtomically:function(e){var t=[];for(var n=0;n<e.length;n++)t=t.concat(this.commitAction(e[n]));this.emitChanges("localChange",t),this.sendToServer()},commitAction:function(e){var n=e[0],r=[];if(n!==t.pass)if(n===t.set)r.push(this.set(e));else if(n===t.stringAdd)r.push(this.stringAdd(e));else{if(n!==t.stringRemove)throw new Error("Unknown Canop action");r.push(this.stringRemove(e))}return r},stringAdd:function(e){return this.local.add(e[1],e[2],e[3],this.base,this.id)},stringRemove:function(e){return this.local.remove(e[1],e[2],e[3],this.base,this.id)},set:function(e){return this.local.set(e[1],e[2],e[3],this.base,this.localId)},signal:function(e){if(this.clientState!==x)return;var t=JSON.stringify(e);try{this.send(JSON.stringify([o,this.id,e]))}catch(n){this.emit("unsyncable",n)}},addClient:function(e){var t=this;e.id=t.nextClientId,e.base=0,t.nextClientId++,t.clients[e.id]=e,t.clientCount++,e.onReceive(function(p){try{var d=t.readProtocol(p)}catch(v){console.error(v);return}var m=d[0];if(m===r){var g=d[1];g!==n?e.send(JSON.stringify([a,[[0,"Unsupported protocol version"]]])):(e.base=t.base,e.send(JSON.stringify([i,t.data,t.base,e.id]))),t.sendSignalsToClient(e)}else if(m===f){var b=d[2];t.removeClient(e);var w=e.id;e.id=d[1],e.base=b,t.clients[e.id]=e;var E=t.operationsSinceBase(b);if(E!==undefined){var S=new y(E),x=E.map(function(e){return e.toProtocol()});e.send(JSON.stringify([l,[],x]))}else e.send(JSON.stringify([u,[[c,"Unknown base"]]]));delete t.signalFromClient[w],t.signalFromClient[e.id]=t.signalFromClient[e.id]||Object.create(null),t.sendSignalsToClient(e)}else if(m===s){var T=y.fromProtocol(d),N=t.receiveSent(T),p=JSON.stringify(N.toProtocol());for(var C in t.clients){var k=t.clients[C];k.send(p)}}else if(m===o){var C=d[1],L=d[2];if(L!==undefined)for(var A in L)t.signalFromClient[C][A]=L[A];for(var C in t.clients)if(e.id!==+C){var k=t.clients[C];k.send(p)}}else console.error("Unknown protocol message "+p)}),this.signalFromClient[e.id]=this.signalFromClient[e.id]||Object.create(null),this.signalFromClient[e.id].connected=!0},sendSignalsToClient:function(e){for(var t in this.clients)if(e.id!==+t){e.send(JSON.stringify([o,+t,this.signalFromClient[t]]));var n=this.clients[t];n.send(JSON.stringify([o,e.id,this.signalFromClient[e.id]]))}},removeClient:function(e){var t=e.id;delete this.clients[t];for(var n in this.clients){var r=this.clients[n];r.send(JSON.stringify([o,+t,{connected:!1}]))}delete this.signalFromClient[t],this.clientCount--},operationsSinceBase:function(e){if(e===this.base)return[];for(var t=this.canon.list.length-1;t>=0;t--)if(this.canon.list[t].mark[0]<=e)return this.canon.list.slice(t+1)},receiveSent:function(e){var t=e.list[0].mark[0],n=e.list[0].mark[1],r=this.operationsSinceBase(t);r===undefined&&(r=this.canon.list);var i=0,s=[];for(var o=0;o<r.length;o++)r[o].mark[1]===n&&(r[o].mark[2]===e.list[i].mark[2]?i++:s.push(r[o]));var u=e.list.slice(0,i),a=e.list.slice(i),s=s.map(function(e){var t=e.dup();return e.original!=null&&(t.action=e.original.action,t.key=e.original.key,t.value=e.original.value),t}),f=e.inverseChange().concat((new y(s)).inverseChange()).concat((new y(r)).change());for(var o=0;o<a.length;o++){var l=a[o],c=a.length-o;l.getModifiedBy(f.slice(c)),f.push(l.change())}e.list=a;for(var o=0;o<e.list.length;o++)this.base++,e.list[o].mark[0]=this.base;return this.canon.apply(e),this.emitChanges("change",e.list,f),this.removeCommonOps(),e},removeCommonOps:function(){var e=this.base;for(var t in this.clients){var n=this.clients[t],r=n.base!==0,i=n.base<e;r&&i&&(e=n.base)}var s=this.canon.list.length-(this.base-e);s>0&&(this.canon.list=this.canon.list.slice(s-1))}},e.operationFromProtocol=y.fromProtocol,e.action=t,e.changePosition=g,e.PosChange=m,e});