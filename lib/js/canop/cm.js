(function(e,t){function r(e,t){this.canopClient=e,this.editor=t,this.editorChange=this.editorChange.bind(this),this.remoteChange=this.remoteChange.bind(this),this.cursorActivity=this.cursorActivity.bind(this),this.signalReceive=this.signalReceive.bind(this),this.editorUndo=this.editorUndo.bind(this),this.editorRedo=this.editorRedo.bind(this),this.commit=this.commit.bind(this),this.canopClient.on("change",this.remoteChange),this.canopClient.on("signal",this.signalReceive),this.clientSelectionWidgets=Object.create(null),this.actionBuffer=[],this.actionBufferTimeout=null,this.commitCallbacks=[],this.editor.undo=this.editorUndo,this.editor.redo=this.editorRedo}var n=e.canop;r.prototype={remoteChange:function(t){var n=this;n.awaitCommit(function(){n.updateEditor(t.changes,t.posChanges)})},awaitCommit:function(e){this.actionBufferTimeout===null?e():this.commitCallbacks.push(e)},commit:function(){this.canopClient.actAtomically(this.actionBuffer),this.actionBuffer=[],this.actionBufferTimeout=null;for(var e=0;e<this.commitCallbacks.length;e++)this.commitCallbacks[e]();this.commitCallbacks=[]},editorChange:function(t,r){var i=[],s=r.from,o=r.to,u=r.text.join("\n"),a=t.getRange(s,o,"\n"),f=t.indexFromPos(s);a.length>0&&i.push([n.action.stringRemove,[],f,a]),u.length>0&&i.push([n.action.stringAdd,[],f,u]),this.actionBuffer=this.actionBuffer.concat(i),this.actionBufferTimeout===null&&(this.actionBufferTimeout=setTimeout(this.commit,100))},cursorActivity:function(t){var n=this,r=n.editor.listSelections().map(function(e){return[n.editor.indexFromPos(e.head),n.editor.indexFromPos(e.anchor)]});n.canopClient.signal({sel:r})},withoutEditorListeners:function(e){this.editor.off("beforeChange",this.editorChange),this.editor.off("cursorActivity",this.cursorActivity),e(),this.editor.on("cursorActivity",this.cursorActivity),this.editor.on("beforeChange",this.editorChange)},resetEditor:function(){var t=this;t.withoutEditorListeners(function(){var e=t.editor.getCursor();t.editor.setValue(""+t.canopClient),t.editor.setCursor(e)})},updateEditor:function(t,n){var r=this;r.withoutEditorListeners(function(){var e=r.getSelections();r.applyDelta(t),r.setSelections(n,e)})},applyDelta:function(t){var r=this;r.editor.changeGeneration(!0),r.editor.operation(function(){for(var e=0;e<t.length;e++){var i=t[e];if(i[1]===n.action.set)r.editor.setValue(i[2]);else if(i[1]===n.action.stringAdd){var s=r.editor.posFromIndex(i[2]);r.editor.replaceRange(i[3],s,s,"*")}else if(i[1]===n.action.stringRemove){var o=r.editor.posFromIndex(i[2]),u=r.editor.posFromIndex(i[2]+i[3].length);r.editor.replaceRange("",o,u,"*")}}})},editorUndo:function(){var e=this;e.withoutEditorListeners(function(){e.applyDelta(e.canopClient.undo())})},editorRedo:function(){var e=this;e.withoutEditorListeners(function(){e.applyDelta(e.canopClient.redo())})},getSelections:function(){var t=this.editor.listSelections(),n=[];for(var r=0;r<t.length;r++){var i=t[r];n.push({anchor:this.editor.indexFromPos(i.anchor),head:this.editor.indexFromPos(i.head)})}return n},setSelections:function(t,r){var i=[];for(var s=0;s<r.length;s++){var o=r[s];i.push({anchor:n.changePosition(this.editor.posFromIndex(o.anchor),t,!0),head:n.changePosition(this.editor.posFromIndex(o.head),t,!0)})}this.editor.setSelections(i)},signalReceive:function(n){var r=n.clientId,i=n.data;this.clientSelectionWidgets[r]=this.clientSelectionWidgets[r]||[];var s=this.clientSelectionWidgets[r];for(var o=0;o<s.length;o++){var u=s[o];u.clear()}if(i!==t&&i.sel!==t){var a=i.sel;for(var o=0;o<a.length;o++){var f=a[o],s=this.addSelection(f,r);this.clientSelectionWidgets[r]=this.clientSelectionWidgets[r].concat(s)}}},addSelection:function(t,n){var r=[this.addUiCursor(t[0],n)];return t[0]!==t[1]&&r.push(this.addUiSelection(t,n)),r},addUiCursor:function(t,n){var r=this.editor.posFromIndex(t),i=this.editor.cursorCoords(r),s=document.createElement("span"),o=this.colorFromName(n.toString());s.style.backgroundColor=o,s.style.width="2px",s.style.marginLeft="-1px",s.style.position="absolute",s.style.height=i.bottom-i.top+"px";var u=document.createElement("span");return u.style.display="none",u.style.padding="0 0.7em",u.style.borderRadius="3px",u.style.backgroundColor=o,u.textContent=n,s.appendChild(u),s.addEventListener("mouseenter",function(){u.style.display="inline"}),s.addEventListener("mouseleave",function(){u.style.display="none"}),this.editor.setBookmark(r,{widget:s,insertLeft:!0})},addUiSelection:function(t,n){var r=this.colorFromName(n.toString(),.9);if(t[0]<t[1])var i=t[0],s=t[1];else var i=t[1],s=t[0];var o=this.editor.posFromIndex(i),u=this.editor.posFromIndex(s);return this.editor.markText(o,u,{css:"background-color:"+r})},rgbFromLch:function(t,n,r){var i=r/60,s=n*(1-Math.abs(i%2-1)),o=0,u=0,a=0;i>=5?(o=n,u=0,a=s):i>=4?(o=s,u=0,a=n):i>=3?(o=0,u=s,a=n):i>=2?(o=0,u=n,a=s):i>=1?(o=s,u=n,a=0):i>=0&&(o=n,u=s,a=0);var f=t-(.3*o+.59*u+.11*a);return o=(o+f)*256|0,u=(u+f)*256|0,a=(a+f)*256|0,"rgb("+o+","+u+","+a+")"},hueFromName:function(t){var n=0;for(var r=0;r<t.length;r++)n=(n+t.charCodeAt(r))%360;return n*93%360},colorFromName:function(n,r){return r===t&&(r=.7),this.rgbFromLch(r,.6,this.hueFromName(n))}},n.ui=n.ui||{},n.ui.codemirror=function(e,t){return new r(e,t)}})(this),function(e,t){var n=e.canop,r=256,i=function(e,n){n=n||{},n.url=n.url||"ws"+window.location.protocol.slice(4)+"//"+window.location.host+"/websocket";var i=this;this.canopClient=e,this.canopClient.send=function(e){if(i.socket===t||i.socket.readyState!==WebSocket.OPEN)throw new Error("WebSocket is not open for business");i.socket.send(e)},this.url=""+n.url,this.socket=null,this.reconnect=n.reconnect===t?!0:!!n.reconnect,this.reconnectionInterval=r,this.receive=this.receive.bind(this),this.connect(n)};i.prototype={connect:function(t){var n=this;this.socket=new WebSocket(this.url),this.socket.addEventListener("message",this.receive),this.socket.addEventListener("close",function(e){n.canopClient.emit("unsyncable"),n.reconnect&&(setTimeout(function(){n.connect(t)},n.reconnectionInterval),n.reconnectionInterval<=6e5&&(n.reconnectionInterval*=2))}),this.socket.addEventListener("open",function(){n.reconnectionInterval=r,n.canopClient.emit("syncing")}),t.error&&this.socket.addEventListener("error",t.error),t.open&&this.socket.addEventListener("open",t.open),t.close&&this.socket.addEventListener("close",t.close)},receive:function(t){this.canopClient.receive(""+t.data)}},n.wire=n.wire||{},n.wire.websocket=function(e,t){return new i(e,t)}}(this);